# 智能窗口管理脚本需求文档

**平台:** macOS

---

## 1. 核心功能

### 1.1. 智能决策：关闭窗口或退出应用

- **需求描述：** 脚本必须能够检测当前处于最前方的应用程序。在触发时，它需要判断该应用正在显示的窗口状态。
- **判断逻辑：**
  - **如果**该应用只剩下最后一个窗口，则执行**退出应用**的操作。
  - **如果**该应用还存在多个窗口，则仅执行**关闭当前窗口**的操作。
- **目标：** 避免在关闭最后一个窗口后，留下一个没有窗口却仍在后台运行的空应用。提升窗口管理的效率和系统的整洁度。

## 2. 例外与特殊处理

### 2.1. 白名单机制：保护常驻应用

- **需求描述：** 对于一些有菜单栏常驻服务或需要在后台持续运行的应用（例如：微信、QQ、音乐播放器、各种工具软件），即便是最后一个窗口被关闭，也不应该退出应用本身。
- **实现方案：**
  - 建立一个“白名单”列表。
  - 在执行“退出应用”的决策前，脚本必须检查当前应用是否位于白名单中。
  - **如果**应用在白名单内，则**无视**“最后一个窗口”的规则，强制执行**关闭窗口**操作。
- **目标：** 保证重要后台服务或常驻应用的持续运行，避免被意外中断。

### 2.2. 安全校验：确保操作目标唯一且正确

- **需求描述：** 在脚本判断（需要几百毫秒）到执行动作（关闭或退出）之间，用户可能已经切换到了其他应用。必须避免在这种情况下对新激活的应用执行错误的操作。
- **实现方案：**
  - 在脚本开始时，记录下目标应用 A 的身份信息（如进程名和 Bundle ID）。
  - 在即将执行关闭或退出动作的瞬间，**再次获取**当前最前方的应用 B 的身份信息。
  - **比对**应用 A 和应用 B 的身份信息。
  - **只有**在 A 和 B 完全一致时，才执行预定的操作。如果不一致，则应取消操作并记录日志。
- **目标：** 杜绝一切因系统延迟或用户快速切换应用而导致的误操作，确保脚本行为的绝对安全。

### 2.3. 非标准窗口处理

- **需求描述：** 当用户关闭“偏好设置”、“关于”等非标准窗口（非 `AXStandardWindow`）时，即使该应用只剩下一个标准窗口，也不应触发退出应用的逻辑。
- **实现方案：**
  - 在判断窗口数量之前，先检查当前要关闭的窗口（`window 1`）的 `subrole` 属性。
  - **如果** `subrole` 不是 `AXStandardWindow`，则**强制**不执行退出操作，仅执行关闭窗口操作。
- **目标：** 符合 macOS 的原生操作习惯，避免在查看设置或关于信息时意外退出应用。

## 3. 技术实现要求

### 3.1. 身份识别：优先使用 Bundle ID

- **需求描述：** 许多应用（特别是基于 Electron 框架的）可能共享同一个进程名（`procName`），例如 “Electron”。如果仅靠进程名来识别应用，会产生混淆，导致白名单、窗口计数等逻辑失效。
- **实现方案：**
  - **必须**使用应用的 **Bundle Identifier** 作为识别应用身份的主要依据。Bundle ID 是唯一的，可以精确指向特定应用（例如 `com.microsoft.VSCode`）。
  - 进程名 `procName` 仅可作为辅助信息或在执行具体 UI 操作（如 `tell application process "..."`）时使用。
  - 所有核心决策逻辑（如白名单匹配）都应**优先基于 Bundle ID**。
- **目标：** 确保脚本能够精确识别每一个应用，为所有功能（特别是白名单）提供一个可靠的基础。

### 3.2. 增强日志输出：详细应用信息记录

- **需求描述：** 为了便于调试、配置白名单以及更好地理解脚本行为，脚本应尽可能详细地获取当前前台应用的相关信息，并将其输出到调试日志中。
- **实现方案：**
  - 在脚本启动获取前台应用信息时，除了 `procName` 和 `bundle identifier`，还应尝试获取并记录：
    - 应用的完整路径 (`appPath`)。
    - 应用的版本号（如果可获取）。
    - 窗口的标题和子角色信息（在窗口计数时已部分实现）。
    - 其他有助于识别或调试应用的关键属性。
- **目标：** 提供丰富的上下文信息，降低配置和排查问题的难度，增强脚本的透明度和用户友好性。
